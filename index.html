<style>body{background:#0b0f19;color:#e8eefc;font-family:system-ui}</style>
const WORKER_BASE = "https://square-union-92c7.ryobump33262.workers.dev";
const proxy = (u) => `${WORKER_BASE}/proxy?url=${encodeURIComponent(u)}`;

// RSS -> 見出し表示
function parseRss(xmlText) {
  const xml = new DOMParser().parseFromString(xmlText, "text/xml");
  return Array.from(xml.querySelectorAll("item")).slice(0, 10).map(it => ({
    title: (it.querySelector("title")?.textContent || "").trim(),
    link: (it.querySelector("link")?.textContent || "").trim(),
  })).filter(x => x.title && x.link);
}

async function loadRSS(rssUrl, elementId) {
  const ul = document.getElementById(elementId);
  ul.innerHTML = "<li>読み込み中…</li>";
  try {
    const res = await fetch(proxy(rssUrl));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const items = parseRss(text);

    ul.innerHTML = "";
    for (const it of items) {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.href = it.link;
      a.textContent = it.title;
      a.target = "_blank";
      a.rel = "noopener";
      li.appendChild(a);
      ul.appendChild(li);
    }
    if (items.length === 0) ul.innerHTML = "<li>記事が見つかりませんでした</li>";
  } catch (e) {
    ul.innerHTML = `<li>読み込み失敗：${e.message}</li>`;
  }
}

// 為替（Frankfurter）-> テーブル表示
async function loadFX() {
  const tbody = document.getElementById("fxTable");
  tbody.innerHTML = `<tr><td>読み込み中…</td><td></td></tr>`;

  try {
    const url = "https://api.frankfurter.dev/v1/latest?base=JPY";
    const res = await fetch(proxy(url));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const rows = Object.entries(data.rates)
      .map(([cur, rate]) => ({ cur, rate }))
      .sort((a, b) => a.cur.localeCompare(b.cur));

    tbody.innerHTML = "";
    for (const r of rows) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.cur}</td><td>${Number(r.rate).toFixed(6)}</td>`;
      tbody.appendChild(tr);
    }
  } catch (e) {
    tbody.innerHTML = `<tr><td>為替表の読み込み失敗</td><td>${e.message}</td></tr>`;
  }
}

// ①Yahooニュース
loadRSS("https://news.yahoo.co.jp/rss/topics/top-picks.xml", "yahoo");

// ②埼玉新聞（Google Newsでsaitama-np.co.jpだけ）
loadRSS("https://news.google.com/rss/search?q=site:saitama-np.co.jp&hl=ja&gl=JP&ceid=JP:ja", "saitama");

// ③円ベース全通貨
loadFX();

// 自動更新（10分）
setInterval(() => {
  loadRSS("https://news.yahoo.co.jp/rss/topics/top-picks.xml", "yahoo");
  loadRSS("https://news.google.com/rss/search?q=site:saitama-np.co.jp&hl=ja&gl=JP&ceid=JP:ja", "saitama");
  loadFX();
}, 10 * 60 * 1000);
<script>
window.addEventListener("error", (e) => {
  document.body.innerHTML = "<pre style='white-space:pre-wrap;padding:12px'>JSエラー:\n" + (e.message || e.error) + "\n\n場所: " + (e.filename||"") + ":" + (e.lineno||"") + "</pre>";
});

window.addEventListener("unhandledrejection", (e) => {
  document.body.innerHTML = "<pre style='white-space:pre-wrap;padding:12px'>Promiseエラー:\n" + (e.reason?.message || e.reason) + "</pre>";
});

document.body.insertAdjacentHTML("afterbegin",
  "<div style='padding:12px'><h1 style='margin:0 0 8px'>表示テスト</h1><div id='status'>JSは動いてます</div></div>"
);
</script>

