<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Simple Dashboard</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;background:#fff;color:#111}
    header{padding:14px 16px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;background:#fff;z-index:10}
    h1{margin:0;font-size:18px}
    .wrap{padding:14px 16px;max-width:1100px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff}
    .card h2{margin:0;padding:10px 12px;font-size:14px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .card .body{padding:10px 12px}
    .muted{color:#6b7280;font-size:12px}
    ul{margin:0;padding-left:18px}
    li{margin:6px 0;line-height:1.4}
    a{color:#2563eb}
    iframe{width:100%;height:320px;border:0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 900px){.row{grid-template-columns:1fr}}
    .pill{font-size:12px;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;color:#374151}
    .status{margin-bottom:12px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb}
    .status b{font-weight:700}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <h1>My Simple Dashboard</h1>
  </header>

  <div class="wrap">
    <div id="status" class="status">
      <b>状態</b>：読み込み中…
      <div class="muted">（うまく取れない場合も、ここに理由を出します）</div>
    </div>

    <!-- 金と原油（TradingView） -->
    <div class="row">
      <section class="card">
        <h2>金（Gold） <span class="pill">チャート</span></h2>
        <iframe
          src="https://s.tradingview.com/widgetembed/?symbol=TVC%3AGOLD&interval=60&hidesidetoolbar=1&theme=light&style=1&timezone=Asia%2FTokyo&withdateranges=1&hidevolume=0">
        </iframe>
      </section>

      <section class="card">
        <h2>原油（WTI） <span class="pill">チャート</span></h2>
        <iframe
          src="https://s.tradingview.com/widgetembed/?symbol=TVC%3AUSOIL&interval=60&hidesidetoolbar=1&theme=light&style=1&timezone=Asia%2FTokyo&withdateranges=1&hidevolume=0">
        </iframe>
      </section>
    </div>

    <!-- ニュース -->
    <div class="grid" style="margin-top:14px;">
      <section class="card">
        <h2>埼玉新聞（見出し） <span class="pill">自動</span></h2>
        <div class="body">
          <div class="muted">Google News RSSで「saitama-np.co.jp」の記事だけ拾います。</div>
          <ul id="saitamaList"><li class="muted">読み込み中…</li></ul>
        </div>
      </section>

      <section class="card">
        <h2>Yahooニュース（見出し） <span class="pill">自動</span></h2>
        <div class="body">
          <ul id="yahooList"><li class="muted">読み込み中…</li></ul>
        </div>
      </section>

      <section class="card">
        <h2>Bloomberg（見出し） <span class="pill">自動</span></h2>
        <div class="body">
          <div class="muted">Google News RSSで「Bloombergのドメイン」を拾います（公式RSSが一定しないため）。</div>
          <ul id="bloombergList"><li class="muted">読み込み中…</li></ul>
        </div>
      </section>

      <section class="card">
        <h2>リンク</h2>
        <div class="body">
          <ul>
            <li><a href="https://x.com/TsutsumiMika" target="_blank" rel="noopener">堤未果さん（X）</a></li>
          </ul>
          <div class="muted">※このページは「自分用まとめ」です（noindex推奨）。</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ---- ここがポイント：無料CORS中継を「複数」試して、取れたやつを採用する ----
    // どれも無料なので、たまに落ちます。落ちても次へ行く設計にしてあります。
    const PROXIES = [
      // allorigins（raw）
      (u) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u),
      // codetabs（※動かない時もある）
      (u) => "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(u),
      // (任意) あなたのCloudflare Workerを使うならここに追加できる：
      // (u) => "https://square-union-92c7.ryobump33262.workers.dev/proxy?url=" + encodeURIComponent(u),
    ];

    const statusEl = document.getElementById("status");
    function setStatus(title, detail){
      statusEl.innerHTML = "<b>" + title + "</b><div class='muted mono'>" + (detail || "") + "</div>";
    }

    async function fetchViaProxies(url){
      let lastErr = "";
      for (const p of PROXIES){
        try{
          const res = await fetch(p(url), { cache: "no-store" });
          if(!res.ok) throw new Error("HTTP " + res.status);
          return await res.text();
        }catch(e){
          lastErr = String(e);
        }
      }
      throw new Error("どの中継でも取得できませんでした: " + lastErr);
    }

    function parseRss(xmlText){
      const xml = new DOMParser().parseFromString(xmlText, "text/xml");
      const items = Array.from(xml.querySelectorAll("item")).slice(0, 10);
      return items.map(it => ({
        title: (it.querySelector("title")?.textContent || "").trim(),
        link: (it.querySelector("link")?.textContent || "").trim()
      })).filter(x => x.title && x.link);
    }

    async function loadRssToList(rssUrl, listId){
      const ul = document.getElementById(listId);
      ul.innerHTML = "<li class='muted'>読み込み中…</li>";
      const xmlText = await fetchViaProxies(rssUrl);
      const items = parseRss(xmlText);

      ul.innerHTML = "";
      for(const it of items){
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = it.link;
        a.textContent = it.title;
        a.target = "_blank";
        a.rel = "noopener";
        li.appendChild(a);
        ul.appendChild(li);
      }
      if(items.length === 0){
        ul.innerHTML = "<li class='muted'>見出しが見つかりませんでした。</li>";
      }
    }

    async function main(){
      try{
        setStatus("状態：読み込み中…", "ニュース見出しを取得しています。");

        // Yahoo RSS（公式トピックス）
        const YAHOO = "https://news.yahoo.co.jp/rss/topics/top-picks.xml";

        // 埼玉新聞：Google News RSSで site:saitama-np.co.jp を抽出
        const SAITAMA = "https://news.google.com/rss/search?q=site:saitama-np.co.jp&hl=ja&gl=JP&ceid=JP:ja";

        // Bloomberg：Google News RSSで bloomberg の記事を抽出（JP優先）
        const BLOOMBERG = "https://news.google.com/rss/search?q=site:bloomberg.co.jp%20OR%20site:bloomberg.com&hl=ja&gl=JP&ceid=JP:ja";

        await Promise.all([
          loadRssToList(SAITAMA, "saitamaList"),
          loadRssToList(YAHOO, "yahooList"),
          loadRssToList(BLOOMBERG, "bloombergList"),
        ]);

        setStatus("状態：OK", "表示に成功しました。うまく出ない枠があれば、その枠だけ対策します。");
      }catch(e){
        setStatus("状態：通信エラー", String(e));
      }
    }

    main();
    setInterval(main, 10 * 60 * 1000); // 10分おきに更新
  </script>
</body>
</html>
